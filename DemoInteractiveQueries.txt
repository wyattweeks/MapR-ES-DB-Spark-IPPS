
#### 3. Run the Spark SQL client to load and query data from MapR-DB with Spark-DB Connector

#You can wait for the java client and spark consumer to finish, or from a separate mac terminal you can run the spark sql with the following command, 
#or you can run from your IDE :
cd /opt/mapr/spark/spark-2.2.1/bin
./spark-submit --class sparkmaprdb.QueryPayment --master local[2] ~/MapR-ES-DB-Spark-Payments/target/mapr-es-db-spark-payment-1.0.jar

# this part - Spark SQL - is an OPTION to the step above
# in a sparate terminal window, start the spark shell with this command
# add paramenter to spark version
# need to automate the 'copy paste step below'
#$ /opt/mapr/spark/spark-2.2.1/bin/spark-shell --master local[2]
#copy paste  from the scripts/sparkshell file to query MapR-DB

#### 4. Working with Drill-JDBC

#From your mac in the mapr-es-db-spark-payment directory you can run the java client to query the MapR-DB table using Drill-JDBC 
# WW -changed to run in dsr-demo
#$ java -cp ~/MapR-ES-DB-Spark-Payments/target/mapr-es-db-spark-payment-1.0.jar:~/MapR-ES-DB-Spark-Payments/target/* maprdb.DRILL_SimpleQuery
#Top 10 physician specialties by total payments
#Query: select physician_specialty,sum(amount) as total from dfs.`/user/mapr/demo.mapr.com/tables/payments` group by physician_specialty order by total desc limit 10
cd /opt/mapr/spark/spark-2.2.1/bin
./spark-submit --class maprdb.DRILL_SimpleQuery --master local[2] --jars /opt/mapr/drill/jars/jdbc-driver/drill-jdbc-all-1.11.0.jar ~/MapR-ES-DB-Spark-Payments/target/mapr-es-db-spark-payment-1.0.jar

#### 5. Working with OJAI
#OJAI the Java API used to access MapR-DB JSON, leverages the same query engine as MapR-DB Shell and Apache Drill to query payments table
#From your mac in the mapr-es-db-spark-payment directory you can run the java client to query the MapR-DB table using OJAI
#$ java -cp ./target/mapr-es-db-spark-payment-1.0.jar:./target/* maprdb.OJAI_SimpleQuery
./spark-submit --class maprdb.OJAI_SimpleQuery --master local[2] --jars /opt/mapr/drill/jars/jdbc-driver/drill-jdbc-all-1.11.0.jar ~/MapR-ES-DB-Spark-Payments/target/mapr-es-db-spark-payment-1.0.jar

#### 6. Using the MapR-DB shell and Drill from your mac client 
#Refer to [**connecting clients **](https://maprdocs.mapr.com/home/MapRContainerDevelopers/ConnectingClients.html) for 
#information on setting up the Drill client
#**Use MapR DB Shell to Query the Payments table**
#In this section you will  use the DB shell to query the Payments JSON table
#To access MapR-DB from your mac client or logged into the container, you can use MapR-DB shell:
$ /opt/mapr/bin/mapr dbshell
#To learn more about the various commands, run help or help <command> , for example help insert.
$ maprdb mapr:> jsonoptions --pretty true --withtags false
#**find 5 documents**
maprdb mapr:> find /user/mapr/demo.mapr.com/tables/payments --limit 5
#Note that queries by _id will be faster because _id is the primary index
#Query document with Condition _id starts with 98485 (physician id)**
maprdb mapr:> find /user/mapr/demo.mapr.com/tables/payments --where '{ "$like" : {"_id":"98485%"} }' --f _id,amount
#**Query document with Condition _id has february**
maprdb mapr:> find /user/mapr/demo.mapr.com/tables/payments --where '{ "$like" : {"_id":"%_02/%"} }' --f _id,amount
#**find all payers=**
maprdb mapr:> find /user/mapr/demo.mapr.com/tables/payments --where '{ "$eq" : {"payer":"Mission Pharmacal Company"} }' --f _id,payer,amount,nature_of_payment
#ctrl-C to exit maprdb shell

#  Use Drill Shell to query MapR-DB  
#From an edge node terminal, connect to Drill as user mapr through JDBC by running sqlline:
# this is CM's original cmd: /opt/mapr/drill/drill-1.11.0/bin/sqlline -u "jdbc:drill:drillbit=localhost" -n mapr
# WW - for dsr-demo, on edge node just: 
sqlline
# 0: jdbc:drill:zk=mapr-zk:5181/drill/dsr-demo->
# WW - changed these to work with dsr-demo
# 1 - Top 5 Physician Ids by Amount**
select physician_id, sum(amount) as revenue from dfs.`/user/mapr/demo.mapr.com/tables/payments` group by physician_id order by revenue desc limit 5;
# 2 - Top 5 nature of payments by Amount**
select nature_of_payment,  sum(amount) as total from dfs.`/user/mapr/demo.mapr.com/tables/payments` group by nature_of_payment order by total desc limit 5;
# 3 - Query for payments for physician id**
select _id,  amount from dfs.`/user/mapr/demo.mapr.com/tables/payments` where _id like '98485%';
# 4 - Query for payments in february**
select _id,  amount from dfs.`/user/mapr/demo.mapr.com/tables/payments` where _id like '%[_]02/%';
# 5 - Queries on payer**
select _id, amount, payer from dfs.`/user/mapr/demo.mapr.com/tables/payments` where payer='CorMatrix Cardiovascular Inc.';
select _id, amount, payer from dfs.`/user/mapr/demo.mapr.com/tables/payments` where payer like '%Dental%';
select  distinct(payer) from dfs.`/user/mapr/demo.mapr.com/tables/payments`;
#!q to exit drill shell


#### 7. Adding a secondary index to the payments JSON table, to speed up queries
# Let's now add indices to the payments table.
# before performance:
$ /opt/mapr/bin/mapr dbshell
maprdb mapr:> find /apps/payments --where '{ "$eq" : {"payer":"Mission Pharmacal Company"} }' --f _id,payer,amount,nature_of_payment
maprdb mapr:> ctrl-c

# In a terminal window create index
#need to convert this to REST
#$ maprcli table index add -path /apps/payments -index idx_payer -indexedfields 'payer:1'
#curl -sSk -X POST -u 'mapr:maprmapr' "https://dsr-demo-pbmggt.se.corp.maprtech.com:8443/rest/table/index/add?path=/user/mapr/demo.mapr.com/tables/payments&index=idx_payer&indexedfields=payer:1"
#ERROR:  mapr@edge-5d5bbc5544-sbgs4:~$ curl -sSk -X POST -u 'mapr:maprmapr' "https://dsr-demo-pbmggt.se.corp.maprtech.com:8443/rest/table/index/add?path=/user/mapr/demo.mapr.com/tables/payments&index=idx_payer&indexedfields=payer:1"
##{"timestamp":1525388489727,"timeofday":"2018-05-03 11:01:29.727 GMT+0000 PM","status":"ERROR","errors":[{"id":22,"desc":"Failed to add index for table: /user/mapr/demo.mapr.com/tables/payments : Cluster Gateways are not configured"}]}mapr@edge-5d5bbc5544-sbgs4:~$

#In MapR-DB Shell, try queries on payments payers and compare with previous query performance:
$ /opt/mapr/bin/mapr dbshell
maprdb mapr:> find /apps/payments --where '{ "$eq" : {"payer":"Mission Pharmacal Company"} }' --f _id,payer,amount,nature_of_payment
maprdb mapr:> ctrl-c


#In Drill try 
$ sqlline
select _id, amount, payer from dfs.`/user/mapr/demo.mapr.com/tables/payments` where payer='CorMatrix Cardiovascular Inc.';
select _id, amount, payer from dfs.`/user/mapr/demo.mapr.com/tables/payments` where payer like '%Dental%';
select  distinct(payer) from dfs.`/user/mapr/demo.mapr.com/tables/payments` ;

##Cleaning Up

#You can delete the topic and table using the following command from a container terminal:
#```
#maprcli stream topic delete -path /mapr/maprdemo.mapr.io/apps/paystream -topic payment
#maprcli table delete -path /mapr/maprdemo.mapr.io/apps/payments

#```
## Conclusion
#
#In this example you have learned how to:

#* Publish using the Kafka API  Medicare Open payments data from a CSV file into MapR-ES 
#* Consume and transform the streaming data with Spark Streaming and the Kafka API
#* Transform the data into JSON format and save to the MapR-DB document database using the Spark-DB connector
#* Query and Load the JSON data from the MapR-DB document database using the Spark-DB connector and Spark SQL 
#* Query the MapR-DB document database using Apache Drill 
#* Query the MapR-DB document database using Java and the OJAI library



You can also look at the following examples:

* [mapr-db-60-getting-started](https://github.com/mapr-demos/mapr-db-60-getting-started) to learn Discover how to use DB Shell, Drill and OJAI to query and update documents, but also how to use indexes.
* [Ojai 2.0 Examples](https://github.com/mapr-demos/ojai-2-examples) to learn more about OJAI 2.0 features
* [MapR-DB Change Data Capture](https://github.com/mapr-demos/mapr-db-cdc-sample) to capture database events such as insert, update, delete and react to this events.
